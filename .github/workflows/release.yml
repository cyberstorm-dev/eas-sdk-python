name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.2.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as prerelease'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.11"

permissions:
  contents: write  # Required for creating releases and uploading assets

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Task
      uses: arduino/setup-task@v2
      with:
        version: 3.x
        
    - name: Validate version format
      run: |
        VERSION="${{ inputs.version }}"
        if [[ ! "$VERSION" =~ ^(v)?[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
          echo "âŒ Invalid version format: $VERSION"
          echo "Expected format: v1.0.0, 1.0.0, v1.0.0-beta.1, or 1.0.0-beta.1"
          exit 1
        fi
        echo "âœ… Version format is valid: $VERSION"
        
    - name: Check if version exists
      run: |
        # Normalize to tag format (with v prefix)
        INPUT_VERSION="${{ inputs.version }}"
        if [[ "$INPUT_VERSION" =~ ^v ]]; then
          TAG_VERSION="$INPUT_VERSION"
        else
          TAG_VERSION="v$INPUT_VERSION"
        fi
        
        if git rev-parse "$TAG_VERSION" >/dev/null 2>&1; then
          echo "âŒ Version $TAG_VERSION already exists as a git tag"
          exit 1
        fi
        echo "âœ… Version $TAG_VERSION is new"

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Task
      uses: arduino/setup-task@v2
      with:
        version: 3.x
        
    - name: Run pre-release checks
      run: task release:check
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/
        retention-days: 30

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Download build artifacts
      uses: actions/download-artifact@v5
      with:
        name: dist-packages
        path: dist/
        
    - name: Extract clean version and ensure tag format
      id: version
      run: |
        # Extract version without 'v' prefix for package naming
        INPUT_VERSION="${{ inputs.version }}"
        CLEAN_VERSION=${INPUT_VERSION#v}
        
        # Ensure tag has 'v' prefix
        if [[ "$INPUT_VERSION" =~ ^v ]]; then
          TAG_VERSION="$INPUT_VERSION"
        else
          TAG_VERSION="v$INPUT_VERSION"
        fi
        
        echo "clean=$CLEAN_VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG_VERSION" >> $GITHUB_OUTPUT
        echo "Clean version: $CLEAN_VERSION"
        echo "Tag version: $TAG_VERSION"
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.tag }}
        prerelease: ${{ inputs.prerelease }}
        generate_release_notes: true
        files: |
          dist/*.tar.gz
          dist/*.whl
        body: |
          ## EAS SDK ${{ steps.version.outputs.tag }}
          
          Python SDK for Ethereum Attestation Service (EAS)
          
          ### ðŸ“¦ Installation
          
          **From PyPI** (recommended):
          ```bash
          pip install eas-sdk==${{ steps.version.outputs.clean }}
          ```
          
          **From wheel**:
          ```bash
          pip install ./eas_sdk-${{ steps.version.outputs.clean }}-py3-none-any.whl
          ```
          
          **From source**:
          ```bash
          pip install ./eas-sdk-${{ steps.version.outputs.clean }}.tar.gz
          ```
          
          ### ðŸš€ Features
          
          - Create and verify attestations on EAS
          - Multi-chain support (Ethereum, Base, Optimism, Arbitrum, Polygon, etc.)
          - Comprehensive schema management
          - Off-chain attestation support with EIP-712
          - Batch operations for gas efficiency
          - Type-safe Python API with full typing support
          
          ### ðŸ“– Documentation
          
          - [Repository](https://github.com/allendy/EAS-sdk)
          - [Issues](https://github.com/allendy/EAS-sdk/issues)
          
          ### ðŸ”— Quick Start
          
          ```python
          from main.EAS import EAS
          
          # Create EAS instance for Base Sepolia testnet
          eas = EAS.from_chain("base-sepolia", private_key, from_account)
          
          # Create an attestation
          result = eas.create_attestation(
              schema_uid="0x...",
              recipient="0x...",
              data={"message": "Hello EAS!"}
          )
          
          print(f"Attestation created: {result.tx_hash}")
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}